**Languages**: [English](CODE_STRUCTURE.md) | [ÁÆÄ‰Ωì‰∏≠Êñá](docs/zh-CN/CODE_STRUCTURE.md)

---

# Code Structure Overview

## Complete Project File Tree

```
Question Analyzer/
‚îú‚îÄ‚îÄ üìÅ Core Extension Files
‚îÇ   ‚îú‚îÄ‚îÄ manifest.json              # Extension config (permissions, version, background)
‚îÇ   ‚îú‚îÄ‚îÄ background.js              # ‚≠ê Background service (subject detection, offscreen mgmt)
‚îÇ   ‚îú‚îÄ‚îÄ package.json               # Dependency versions
‚îÇ   ‚îî‚îÄ‚îÄ supabase-config.js         # Supabase config (URL, anon key)
‚îÇ
‚îú‚îÄ‚îÄ üìÅ Content Scripts (Injected into webpages)
‚îÇ   ‚îú‚îÄ‚îÄ content/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analyzer-ui.js         # Floating panel UI (parse, render, interact)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ analyzer-ui.css        # Panel styling
‚îÇ   ‚îî‚îÄ‚îÄ scripts/
‚îÇ       ‚îî‚îÄ‚îÄ extract-content.js     # ‚≠ê Content extraction (Defuddle, answer detection, A-D)
‚îÇ
‚îú‚îÄ‚îÄ üìÅ AI Processing Core
‚îÇ   ‚îî‚îÄ‚îÄ offscreen/
‚îÇ       ‚îú‚îÄ‚îÄ offscreen.html         # Offscreen Document HTML (shell)
‚îÇ       ‚îî‚îÄ‚îÄ offscreen.js           # ‚≠ê‚≠ê‚≠ê AI Engine (LanguageModel API, prompt injection)
‚îÇ
‚îú‚îÄ‚îÄ üìÅ Popup Control
‚îÇ   ‚îî‚îÄ‚îÄ popup/
‚îÇ       ‚îú‚îÄ‚îÄ popup.html             # Popup UI
‚îÇ       ‚îú‚îÄ‚îÄ popup.js               # Auto-scan toggle, manual analysis
‚îÇ       ‚îî‚îÄ‚îÄ popup.css              # Popup styling
‚îÇ
‚îú‚îÄ‚îÄ üìÅ Misconceptions Page
‚îÇ   ‚îî‚îÄ‚îÄ misconceptions/
‚îÇ       ‚îú‚îÄ‚îÄ misconceptions.html    # Misconceptions HTML
‚îÇ       ‚îú‚îÄ‚îÄ misconceptions.js      # Dedup display, export, delete
‚îÇ       ‚îî‚îÄ‚îÄ misconceptions.css     # Misconceptions styling
‚îÇ
‚îú‚îÄ‚îÄ üìÅ Shared Utilities
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ markdown-renderer.js   # ‚≠ê Markdown + LaTeX rendering (Marked + KaTeX)
‚îÇ       ‚îú‚îÄ‚îÄ hash.js                # FNV-1a hash, fingerprint generation
‚îÇ       ‚îî‚îÄ‚îÄ supabase-service.js    # Cloud service (feedback, recommendations)
‚îÇ
‚îú‚îÄ‚îÄ üìÅ Assets
‚îÇ   ‚îî‚îÄ‚îÄ images/                    # Extension icons (16/32/48/128px)
‚îÇ       ‚îú‚îÄ‚îÄ icon16.png
‚îÇ       ‚îú‚îÄ‚îÄ icon32.png
‚îÇ       ‚îú‚îÄ‚îÄ icon48.png
‚îÇ       ‚îî‚îÄ‚îÄ icon128.png
‚îÇ
‚îú‚îÄ‚îÄ üìÅ Build Configuration
‚îÇ   ‚îú‚îÄ‚îÄ rollup.config.mjs          # Rollup bundling config
‚îÇ   ‚îú‚îÄ‚îÄ package-lock.json          # Dependency lock
‚îÇ   ‚îî‚îÄ‚îÄ dist/                      # Build output directory (load into Chrome)
‚îÇ       ‚îú‚îÄ‚îÄ background.js
‚îÇ       ‚îú‚îÄ‚îÄ content/
‚îÇ       ‚îú‚îÄ‚îÄ offscreen/
‚îÇ       ‚îú‚îÄ‚îÄ popup/
‚îÇ       ‚îú‚îÄ‚îÄ misconceptions/
‚îÇ       ‚îú‚îÄ‚îÄ utils/
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îî‚îÄ‚îÄ üìÅ Documentation
    ‚îú‚îÄ‚îÄ README.md                  # User guide
    ‚îú‚îÄ‚îÄ ARCHITECTURE.md            # System architecture (AI detailed)
    ‚îú‚îÄ‚îÄ TECHNICAL_DOCS.md          # Technical docs (prompt engineering detailed)
    ‚îî‚îÄ‚îÄ CODE_STRUCTURE.md          # This file
```

## ‚≠ê AI-Related Files (Highlighted)

### offscreen/offscreen.js (AI Core Engine)
**Most Important File**, responsible for all AI inference logic:
- LanguageModel API integration
- Session singleton management (create + error recovery)
- **Prompt Dynamic Injection**:
  - `${subject}` - Subject name
  - `${expA/B/C/D}` - College Board A-D explanations
  - `${userAnswer}`, `${correctAnswer}` - Student/correct answers
- Complete prompt template (THINKING + IMPORTANT + HINT)
- Debug mode logging output

**Key Code**:
```javascript
async function analyzeQuestion(content, context) {
  const { subject, rationales, userAnswer, correctAnswer } = context;
  
  // Extract A-D explanations
  const expA = rationales?.[0]?.rationale || 'None';
  const expB = rationales?.[1]?.rationale || 'None';
  const expC = rationales?.[2]?.rationale || 'None';
  const expD = rationales?.[3]?.rationale || 'None';
  
  // Build prompt
  const prompt = `You are an expert AI tutor in ${subject}...`;
  
  // Inference
  const result = await session.prompt(prompt);
  return { success: true, result };
}
```

---

### background.js (Subject Detection + Offscreen Management)
**Second Most Important File**, coordinates the entire analysis flow:
- **Subject Detection Function**: `detectSubjectFromUrl(url)`
  - Regex extraction: `/apclassroom\.collegeboard\.org\/(\d+)/`
  - Mapping table: 13 AP subjects
- **Offscreen Lifecycle**: `ensureOffscreenDocument()`
  - Singleton creation
  - Health check (ping/pong)
- Analysis trigger: `triggerAnalysis(tabId, content, url, context)`
- Cache management: 1-hour TTL
- Message routing: Background ‚Üî Offscreen ‚Üî Content

**Key Code**:
```javascript
function detectSubjectFromUrl(url) {
  const match = url && url.match(/apclassroom\.collegeboard\.org\/(\d+)/);
  const id = match ? match[1] : null;
  const map = {
    '7': 'AP Chemistry',
    '8': 'AP Computer Science A',
    '93': 'AP Physics 2',
    // ... total 13 subjects
  };
  return id && map[id] ? map[id] : 'Unknown';
}
```

---

### scripts/extract-content.js (A-D Explanations Extraction)
**Third Most Important File**, provides raw materials for AI:
- **Answer Detection**: `detectUserAnswer(document)`
  - Student selection: `aria-selected="true"` / `.--chosen`
  - Correct answer: `.icon.--correct` / `.lrn_valid`
- **A-D Official Explanations**: `extractRationales(document)`
  - DOM search: `.LearnosityDistractor .content`
  - Map by index to A/B/C/D
- **Visible Question Priority**: `findVisibleQuestionRoot(document)`
  - Solves multi-question page issue
- Defuddle content extraction
- Turndown HTML ‚Üí Markdown
- LaTeX preservation handling

**Key Code**:
```javascript
function extractRationales(document) {
  const rationales = [];
  const visibleRoot = findVisibleQuestionRoot(document);
  const allOptions = visibleRoot.querySelectorAll('.mcq-option');
  
  allOptions.forEach((option, index) => {
    const distractor = option.closest('.LearnosityDistractor');
    const contentEl = distractor?.querySelector('.content');
    if (contentEl) {
      const letter = ['A', 'B', 'C', 'D', 'E'][index];
      rationales.push({ answer: letter, rationale: contentEl.textContent.trim() });
    }
  });
  
  return rationales;
}
```

---

## Other File Responsibilities (Brief)

### Core Extension Files
- **`manifest.json`**: Manifest V3 config, permissions declaration, background entry
- **`package.json`**: npm dependencies (defuddle, turndown, marked, katex, supabase-js)
- **`supabase-config.js`**: Supabase URL and anonymous key

### Content Scripts (UI)
- **`content/analyzer-ui.js`**: Floating panel, parse AI output, LaTeX rendering, feedback/save
- **`content/analyzer-ui.css`**: Panel styling (float, minimize, animations)

### Popup & Misconceptions
- **`popup/popup.js`**: Auto-scan toggle, manual analysis button, misconceptions entry
- **`misconceptions/misconceptions.js`**: Dedup display, export JSON/CSV, delete

### Shared Utilities
- **`utils/markdown-renderer.js`**: Marked.js + KaTeX config, custom LaTeX renderer
- **`utils/hash.js`**: FNV-1a hash, `buildFingerprint()` misconception deduplication
- **`utils/supabase-service.js`**: Cloud feedback, community recommendations, URL hashing

## Dependencies

### Core Libraries
| Library | Version | Purpose | AI-Related |
|---------|---------|---------|------------|
| defuddle | 0.6.6 | Intelligent webpage content extraction | ‚úÖ Provides question content for AI |
| turndown | 7.2.0 | HTML ‚Üí Markdown | ‚úÖ Converts to AI-readable format |
| turndown-plugin-gfm | 1.0.2 | GitHub Flavored Markdown | - |
| marked | 14.1.2 | Markdown ‚Üí HTML | Renders AI output |
| katex | 0.16.9 | LaTeX rendering | Renders math formulas |
| dompurify | 3.2.4 | XSS protection | - |
| @supabase/supabase-js | 2.39.3 | Cloud service | - |

### Build Tools
```json
{
  "rollup": "4.22.4",
  "@rollup/plugin-node-resolve": "15.2.3",
  "@rollup/plugin-commonjs": "26.0.1",
  "rollup-plugin-copy": "3.5.0"
}
```

---

## Build Process

### Rollup Bundling Configuration (rollup.config.mjs)
```javascript
export default [
  // 1. Static asset copying
  {
    input: 'scripts/extract-content.js',
    plugins: [
      copy({
        targets: [
          { src: 'manifest.json', dest: 'dist' },
          { src: 'images', dest: 'dist' },
          { src: 'supabase-config.js', dest: 'dist' },
          { src: 'content/analyzer-ui.css', dest: 'dist/content' },
          { src: 'node_modules/katex/dist/katex.min.css', dest: 'dist/node_modules/katex/dist' },
          ...
        ]
      })
    ]
  },
  
  // 2. Bundle JS files (ES Modules ‚Üí IIFE)
  { input: 'background.js', output: { file: 'dist/background.js', format: 'iife' } },
  { input: 'offscreen/offscreen.js', output: { dir: 'dist/offscreen', format: 'iife' } },
  { input: 'content/analyzer-ui.js', output: { dir: 'dist/content', format: 'iife' } },
  { input: 'popup/popup.js', output: { dir: 'dist/popup', format: 'iife' } },
  { input: 'misconceptions/misconceptions.js', output: { dir: 'dist/misconceptions', format: 'iife' } },
  { input: 'scripts/extract-content.js', output: { dir: 'dist/scripts', format: 'es' } }
]
```

### Input ‚Üí Output Mapping
| Source File | Output File | Format | AI-Related |
|-------------|-------------|--------|------------|
| `background.js` | `dist/background.js` | IIFE | ‚úÖ Subject detection |
| `offscreen/offscreen.js` | `dist/offscreen/offscreen.js` | IIFE | ‚≠ê‚≠ê‚≠ê AI Core |
| `scripts/extract-content.js` | `dist/scripts/extract-content.js` | ES | ‚úÖ A-D extraction |
| `content/analyzer-ui.js` | `dist/content/analyzer-ui.js` | IIFE | Renders AI output |
| `popup/popup.js` | `dist/popup/popup.js` | IIFE | - |
| `misconceptions/misconceptions.js` | `dist/misconceptions/misconceptions.js` | IIFE | - |

### Build Command
```bash
npm run build
```

Build output directory structure:
```
dist/
‚îú‚îÄ‚îÄ manifest.json
‚îú‚îÄ‚îÄ background.js            # ‚Üê Subject detection, Offscreen mgmt
‚îú‚îÄ‚îÄ supabase-config.js
‚îú‚îÄ‚îÄ offscreen/
‚îÇ   ‚îú‚îÄ‚îÄ offscreen.html
‚îÇ   ‚îî‚îÄ‚îÄ offscreen.js         # ‚Üê ‚≠ê‚≠ê‚≠ê AI Engine
‚îú‚îÄ‚îÄ content/
‚îÇ   ‚îú‚îÄ‚îÄ analyzer-ui.js
‚îÇ   ‚îî‚îÄ‚îÄ analyzer-ui.css
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ extract-content.js   # ‚Üê A-D explanations extraction
‚îú‚îÄ‚îÄ popup/
‚îú‚îÄ‚îÄ misconceptions/
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ markdown-renderer.js
‚îÇ   ‚îú‚îÄ‚îÄ hash.js
‚îÇ   ‚îî‚îÄ‚îÄ supabase-service.js
‚îú‚îÄ‚îÄ images/
‚îî‚îÄ‚îÄ node_modules/katex/dist/katex.min.css
```

---

## Code Quality Features

### Error Handling
- **LanguageModel API Unavailable**: Prompt user to enable Gemini Nano
- **Session Creation Failure**: Auto-destroy and rebuild
- **LaTeX Rendering Errors**: Fallback to raw formula display
- **Supabase Failures**: Fail silently, doesn't affect core functionality

### Performance Optimizations
- ‚úÖ **1-hour Cache**: Same URL won't be re-analyzed
- ‚úÖ **Session Reuse**: Multiple analyses share one LanguageModel session
- ‚úÖ **Offscreen Singleton**: Created only once per extension lifecycle
- ‚úÖ **LaTeX Batch Rendering**: `renderLatexInElement` processes all at once

### Security Measures
- ‚úÖ **DOMPurify Filtering**: Prevents XSS attacks
- ‚úÖ **Local AI**: Gemini Nano offline inference
- ‚úÖ **URL Hashing**: Supabase only stores SHA-256(url)
- ‚úÖ **CSP Policy**: Manifest V3 content security policy

### Maintainability
- ‚úÖ **Modular Design**: AI logic isolated in offscreen
- ‚úÖ **Shared Utilities**: `utils/` directory centralizes utility functions
- ‚úÖ **Separation of Concerns**: UI, extraction, AI inference each has its role
- ‚úÖ **Detailed Documentation**: ARCHITECTURE.md (AI detailed) + TECHNICAL_DOCS.md (prompt detailed)

---

## Development Workflow

1. **Development**: Edit source files (`offscreen/`, `background.js`, ...)
2. **Build**: `npm run build` ‚Üí Generate `dist/` directory
3. **Testing**:
   - Open `chrome://extensions/`
   - Enable "Developer mode"
   - Click "Load unpacked"
   - Select `dist/` folder
4. **Debug AI**:
   - Open `chrome://extensions/` ‚Üí Background page ‚Üí Console
   - View `[AI Prompt]` collapsed logs
   - Verify `subject`, `expA/B/C/D` injection
5. **Deployment**: Package `dist/` folder for Chrome Web Store submission

---

## Quick Reference: AI Code Trace

Want to understand how AI works? Read code in this order:

1. **`background.js:604-630`** ‚Üí `detectSubjectFromUrl()` Subject detection
2. **`background.js:380-558`** ‚Üí `triggerAnalysis()` Trigger analysis
3. **`scripts/extract-content.js:434-524`** ‚Üí `extractRationales()` Extract A-D explanations
4. **`offscreen/offscreen.js:30-111`** ‚Üí `analyzeQuestion()` AI inference core
5. **`content/analyzer-ui.js:243-276`** ‚Üí `parseAnalysis()` Parse output
6. **`content/analyzer-ui.js:193-241`** ‚Üí `showAnalysis()` Render results
