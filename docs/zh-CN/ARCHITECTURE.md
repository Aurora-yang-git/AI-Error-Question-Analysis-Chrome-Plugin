**è¯­è¨€**: [English](../../ARCHITECTURE.md) | [ç®€ä½“ä¸­æ–‡](ARCHITECTURE.md)

---

# Question Analyzer - ç³»ç»Ÿæ¶æ„

## ç³»ç»Ÿæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Chrome æµè§ˆå™¨                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AP Classroom ç½‘é¡µ          â”‚  Chrome æ‰©å±•                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â€¢ College Board é¢˜ç›® â”‚   â”‚  â”‚ Background Script (Service Worker)  â”‚ â”‚
â”‚  â”‚ â€¢ LaTeX æ•°å­¦å…¬å¼     â”‚   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â€¢ å››é€‰é¡¹é€‰æ‹©é¢˜       â”‚   â”‚  â”‚ â”‚ â€¢ Tab äº‹ä»¶ç›‘å¬                   â”‚ â”‚ â”‚
â”‚  â”‚ â€¢ A-D å®˜æ–¹è§£é‡Š       â”‚   â”‚  â”‚ â”‚ â€¢ å­¦ç§‘è¯†åˆ« (URL â†’ Subject)       â”‚ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚ â”‚ â€¢ å†…å®¹æå–åè°ƒ                   â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â€¢ Offscreen ç”Ÿå‘½å‘¨æœŸç®¡ç†         â”‚ â”‚ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚ â”‚ â€¢ ç¼“å­˜ç®¡ç† (1h TTL)              â”‚ â”‚ â”‚
â”‚  â”‚ æµ®åŠ¨åˆ†æé¢æ¿ (æ³¨å…¥)  â”‚   â”‚  â”‚ â”‚ â€¢ æ¶ˆæ¯è·¯ç”±ä¸­æ¢                   â”‚ â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚ â”‚ ğŸ§² AP Physics 2 â”‚ â”‚   â”‚  â”‚                                      â”‚ â”‚
â”‚  â”‚ â”‚ ğŸ’¡ Misconception â”‚ â”‚   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚ ğŸ‘ ğŸ‘ â˜† Save     â”‚ â”‚   â”‚  â”‚ â”‚ Content Script (analyzer-ui.js)  â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ LaTeX æ¸²æŸ“æ”¯æŒ   â”‚ â”‚   â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â”‚ â”‚ â”‚ â€¢ æµ®åŠ¨é¢æ¿ç®¡ç†               â”‚ â”‚ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚ â”‚ â”‚ â€¢ Markdown + LaTeX æ¸²æŸ“     â”‚ â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â”‚ â€¢ åé¦ˆæŒ‰é’®å¤„ç†               â”‚ â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â”‚ â€¢ é”™é¢˜ä¿å­˜é€»è¾‘               â”‚ â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                              â”‚  â”‚                                      â”‚ â”‚
â”‚                              â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â­ Offscreen Document (AI æ ¸å¿ƒ)  â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â”‚ â€¢ LanguageModel API         â”‚ â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â”‚ â€¢ Session å•ä¾‹ç®¡ç†          â”‚ â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â”‚ â€¢ æç¤ºè¯æ³¨å…¥ (${subject})   â”‚ â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â”‚ â€¢ Gemini Nano æ¨ç†          â”‚ â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â”‚ â€¢ é”™è¯¯æ¢å¤ (session reset)  â”‚ â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                              â”‚  â”‚                                      â”‚ â”‚
â”‚                              â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ Popup (å¼¹çª—æ§åˆ¶)                 â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â€¢ è‡ªåŠ¨æ‰«æå¼€å…³                   â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â€¢ æ‰‹åŠ¨åˆ†æè§¦å‘                   â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â€¢ é”™é¢˜æœ¬å…¥å£                     â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                              â”‚  â”‚                                      â”‚ â”‚
â”‚                              â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ Misconceptions Page (é”™é¢˜æœ¬)     â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â€¢ å»é‡å±•ç¤º (fingerprint)         â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â€¢ å­¦ç§‘è¿‡æ»¤                       â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â€¢ å¯¼å‡ºåŠŸèƒ½                       â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                              â”‚  â”‚                                      â”‚ â”‚
â”‚                              â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ Supabase Cloud (å¯é€‰)            â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â€¢ ç¤¾åŒºæ¨èåˆ†æ                   â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ â€¢ åé¦ˆç»Ÿè®¡                       â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ AI å¤„ç†æ ¸å¿ƒæ¶æ„ï¼ˆè¯¦ç»†ï¼‰

### Offscreen Document AI å¼•æ“

#### æ¶æ„è®¾è®¡åŸç†
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Background.js (Service Worker)                     â”‚
â”‚  - æ—  DOM ç¯å¢ƒï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨ LanguageModel API      â”‚
â”‚  - è´Ÿè´£åè°ƒå’Œæ¶ˆæ¯ä¼ é€’                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ chrome.runtime.sendMessage()
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Offscreen Document (offscreen.html + .js)          â”‚
â”‚  - æä¾› DOM ä¸Šä¸‹æ–‡                                  â”‚
â”‚  - æ‰˜ç®¡ LanguageModel API                           â”‚
â”‚  - å•ä¾‹ Session ç®¡ç†                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ LanguageModel.create() / session.prompt()
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gemini Nano (Chrome å†…ç½® AI)                       â”‚
â”‚  - æœ¬åœ°æ¨ç†ï¼Œæ— ç½‘ç»œè¯·æ±‚                             â”‚
â”‚  - æ¥æ”¶æç¤ºè¯ï¼Œè¿”å›æ–‡æœ¬                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®Œæ•´æ¶ˆæ¯æµç¨‹
```javascript
// 1. Background è§¦å‘åˆ†æ
async function triggerAnalysis(tabId, content, url, context) {
  const subject = detectSubjectFromUrl(url); // â† å­¦ç§‘è¯†åˆ«
  
  await ensureOffscreenDocument(); // â† ç¡®ä¿ offscreen å­˜åœ¨
  
  // 2. å‘é€åˆ†æè¯·æ±‚
  const response = await chrome.runtime.sendMessage({
    action: 'analyzeQuestion',
    content: content,
    userAnswer: context.userAnswer,
    correctAnswer: context.correctAnswer,
    rationales: context.rationales,  // â† A-D å®˜æ–¹è§£é‡Š
    subject: subject,                // â† æ³¨å…¥å­¦ç§‘
    url: url,
    debug: true
  });
  
  // 3. å¤„ç†è¿”å›ç»“æœ
  if (response.success) {
    await chrome.tabs.sendMessage(tabId, {
      action: 'showAnalysis',
      result: response.result,
      subject: subject
    });
  }
}

// Offscreen å¤„ç†
async function analyzeQuestion(content, context) {
  const { subject, rationales, userAnswer, correctAnswer } = context;
  
  // æå– A-D è§£é‡Š
  const expA = rationales?.[0]?.rationale || 'None';
  const expB = rationales?.[1]?.rationale || 'None';
  const expC = rationales?.[2]?.rationale || 'None';
  const expD = rationales?.[3]?.rationale || 'None';
  
  // æ„å»ºæç¤ºè¯ï¼ˆå«å­¦ç§‘å’ŒA-Dè§£é‡Šï¼‰
  const prompt = `You are an expert AI tutor analyzing a student's answer 
to identify and clarify misconceptions in the subject of ${subject}.

Question content: ${content}
Correct Answer: ${correctAnswer}
Student Answer: ${userAnswer}

College Board Explanation (for reference only):
A: ${expA}
B: ${expB}
C: ${expC}
D: ${expD}

THINKING: ...
IMPORTANT: ...
HINT: ...`;
  
  // AI æ¨ç†
  const result = await session.prompt(prompt);
  return { success: true, result };
}
```

#### Session ç”Ÿå‘½å‘¨æœŸç®¡ç†
```javascript
let session = null; // å…¨å±€å•ä¾‹

// åˆ›å»º Session
if (!session) {
  session = await LanguageModel.create({
    temperature: 0.7,   // åˆ›é€ æ€§ vs ä¸€è‡´æ€§
    topK: 3,            // å€™é€‰è¯é™åˆ¶
    outputLanguage: 'en'
  });
}

// é”™è¯¯æ¢å¤
catch (error) {
  if (session) {
    session.destroy();  // é”€æ¯æŸåçš„ session
    session = null;     // ä¸‹æ¬¡é‡æ–°åˆ›å»º
  }
  throw error;
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š
- âœ… **å»¶è¿Ÿåˆ›å»º**ï¼šé¦–æ¬¡åˆ†ææ—¶æ‰åˆ›å»ºï¼ŒèŠ‚çœèµ„æº
- âœ… **Session å¤ç”¨**ï¼šå¤šæ¬¡åˆ†æå…±äº« sessionï¼Œæå‡æ€§èƒ½
- âœ… **è‡ªåŠ¨æ¢å¤**ï¼šé”™è¯¯æ—¶é”€æ¯ï¼Œä¸‹æ¬¡è‡ªåŠ¨é‡å»º
- âœ… **å•ä¾‹æ¨¡å¼**ï¼šæ•´ä¸ªæ‰©å±•ç”Ÿå‘½å‘¨æœŸä»…ä¸€ä¸ª session

---

### æç¤ºè¯åŠ¨æ€æ³¨å…¥æµç¨‹

#### å­¦ç§‘è¯†åˆ« â†’ æç¤ºè¯æ³¨å…¥
```
1. ç”¨æˆ·è®¿é—® AP Classroom é¢˜ç›®
   URL: https://apclassroom.collegeboard.org/93/assessments/...
              â†“
2. Background ç›‘å¬ tab.onUpdated
   detectSubjectFromUrl(url) 
   â†’ æ­£åˆ™åŒ¹é…: /apclassroom\.collegeboard\.org\/(\d+)/
   â†’ æå– ID: 93
              â†“
3. æŸ¥è¯¢æ˜ å°„è¡¨
   { '93': 'AP Physics 2', '26': 'AP Calculus BC', ... }
   â†’ subject = 'AP Physics 2'
              â†“
4. å‘é€åˆ° Offscreen
   { action: 'analyzeQuestion', subject: 'AP Physics 2', ... }
              â†“
5. æ¨¡æ¿å­—ç¬¦ä¸²æ›¿æ¢
   `You are an expert AI tutor in ${subject}` 
   â†’ "You are an expert AI tutor in AP Physics 2"
              â†“
6. Gemini Nano æ¥æ”¶å®Œæ•´æç¤ºè¯
   â†’ ä½¿ç”¨ç‰©ç†å­¦æœ¯è¯­å’Œæ€ç»´æ¡†æ¶è¿›è¡Œåˆ†æ
```

#### A-D å®˜æ–¹è§£é‡Šæå–æµç¨‹
```
1. Content Extraction Script æ‰§è¡Œ
   scripts/extract-content.js
              â†“
2. æŸ¥æ‰¾ DOM ç»“æ„
   visibleRoot.querySelectorAll('.LearnosityDistractor')
              â†“
3. æå–æ¯ä¸ªé€‰é¡¹çš„è§£é‡Š
   Option A: distractor[0].querySelector('.content').textContent
   Option B: distractor[1].querySelector('.content').textContent
   ...
              â†“
4. æ„å»º rationales æ•°ç»„
   [
     { answer: 'A', rationale: '...' },
     { answer: 'B', rationale: '...' },
     { answer: 'C', rationale: '...' },
     { answer: 'D', rationale: '...' }
   ]
              â†“
5. ä¼ é€’åˆ° Offscreen
   { rationales: [...] }
              â†“
6. æ˜ å°„åˆ° A-D å˜é‡
   expA = rationales[0].rationale
   expB = rationales[1].rationale
   ...
              â†“
7. æ³¨å…¥æç¤ºè¯
   College Board Explanation:
   A: ${expA}
   B: ${expB}
   C: ${expC}
   D: ${expD}
```

---

### ç»“æ„åŒ–è¾“å‡ºå¤„ç†é“¾è·¯

#### AI è¾“å‡º â†’ å‰ç«¯æ¸²æŸ“
```
1. Gemini Nano è¿”å›æ–‡æœ¬
   "**Misconception**: If the magnet were removed, the paper clip 
    would no longer attract others, so the clip is only temporarily 
    magnetized rather than a permanent magnet."
              â†“
2. Offscreen è¿”å›ç»™ Background
   { success: true, result: "**Misconception**: ..." }
              â†“
3. Background ç¼“å­˜ + å‘é€ç»™ Content Script
   chrome.storage.local.set({ [`analysis_${url}`]: { content: result } })
   chrome.tabs.sendMessage(tabId, { action: 'showAnalysis', result })
              â†“
4. Content Script è§£æ Markdown
   parseAnalysis(markdown)
   â†’ æ­£åˆ™æå–: /\*\*Misconception\*\*:\s*([^\n]+)/
   â†’ misconception = "If the magnet were removed..."
              â†“
5. æ„å»º HTML
   <div class="qa-misconception-box">
     <div class="qa-misconception-label">ğŸ’¡ Misconception Identified</div>
     <div class="qa-misconception-text">${misconception}</div>
   </div>
              â†“
6. æ¸²æŸ“ LaTeX
   renderLatexInElement(resultDiv)
   â†’ KaTeX æ¸²æŸ“æ‰€æœ‰ $...$ å’Œ $$...$$ å…¬å¼
              â†“
7. ç”¨æˆ·çœ‹åˆ°é«˜äº®çš„ Misconception å¡ç‰‡
```

---

## å…¶ä»–ç»„ä»¶æ¶æ„ï¼ˆç®€è¿°ï¼‰

### 1. Background Script (`background.js`)
**æ ¸å¿ƒèŒè´£**ï¼š
- Tab äº‹ä»¶ç›‘å¬ï¼ˆonActivated, onUpdatedï¼‰
- **å­¦ç§‘è¯†åˆ«**ï¼š`detectSubjectFromUrl(url)` â†’ 13 ä¸ª AP ç§‘ç›®æ˜ å°„
- å†…å®¹æå–åè°ƒï¼šæ³¨å…¥ `extract-content.js`
- **Offscreen ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š`ensureOffscreenDocument()`
- ç¼“å­˜ç®¡ç†ï¼š1 å°æ—¶ TTL
- æ¶ˆæ¯è·¯ç”±ï¼šBackground â†” Offscreen â†” Content Script

### 2. Content Script (`content/analyzer-ui.js`)
**æ ¸å¿ƒèŒè´£**ï¼š
- æµ®åŠ¨é¢æ¿ç®¡ç†ï¼ˆåˆå§‹åŒ–ã€æ˜¾ç¤ºã€éšè—ï¼‰
- Markdown + LaTeX æ¸²æŸ“
- è§£æ AI è¾“å‡ºï¼ˆæå– `**Misconception**`ï¼‰
- åé¦ˆæŒ‰é’®ï¼šğŸ‘ ğŸ‘ â†’ å‘é€åˆ° Supabase
- ä¿å­˜é”™é¢˜ï¼šâ˜† Save â†’ æœ¬åœ° storage

### 3. Content Extraction (`scripts/extract-content.js`)
**æ ¸å¿ƒèŒè´£**ï¼š
- **Defuddle** æ™ºèƒ½æå–ç½‘é¡µä¸»ä½“å†…å®¹
- **Turndown** HTML â†’ Markdown è½¬æ¢
- **LaTeX ä¿ç•™**ï¼šè¯†åˆ« `<img alt="...">` å’Œ `.math` å…ƒç´ 
- **ç­”æ¡ˆæ£€æµ‹**ï¼š`aria-selected="true"` / `.--chosen`
- **A-D è§£é‡Šæå–**ï¼š`.LearnosityDistractor .content`
- **å¯è§é¢˜ç›®ä¼˜å…ˆ**ï¼š`offsetParent !== null`

### 4. å…¶ä»–ç»„ä»¶
- **Popup**ï¼šè‡ªåŠ¨æ‰«æå¼€å…³ã€æ‰‹åŠ¨åˆ†æè§¦å‘ã€é”™é¢˜æœ¬å…¥å£
- **Misconceptions Page**ï¼šå»é‡å±•ç¤ºã€å­¦ç§‘è¿‡æ»¤ã€å¯¼å‡ºåŠŸèƒ½
- **Shared Utilities**ï¼šMarkdown æ¸²æŸ“ã€å“ˆå¸Œç®—æ³•ã€äº‘ç«¯æœåŠ¡

---

## å®Œæ•´æ•°æ®æµï¼ˆå« AI æ¨ç†ç»†èŠ‚ï¼‰

```
1. ç”¨æˆ·è®¿é—® AP Classroom é¢˜ç›®é¡µé¢
   â†’ detectSubjectFromUrl(url) â†’ subject = 'AP Physics 2'
              â†“
2. æ³¨å…¥ Content Extraction Script
   â†’ æå–å†…å®¹ã€ç­”æ¡ˆã€A-D è§£é‡Š
              â†“
3. Background æ£€æŸ¥ç¼“å­˜
   â†’ ç¼“å­˜å‘½ä¸­ï¼šç›´æ¥æ˜¾ç¤º | ç¼“å­˜æœªå‘½ä¸­ï¼šè§¦å‘æ–°åˆ†æ
              â†“
4. ç¡®ä¿ Offscreen Document å­˜åœ¨
   â†’ å•ä¾‹åˆ›å»ºï¼Œå»¶è¿Ÿåˆå§‹åŒ–
              â†“
5. å‘é€åˆ†æè¯·æ±‚åˆ° Offscreen
   â†’ subjectã€rationalesã€userAnswerã€correctAnswer
              â†“
6. Offscreen åˆ›å»º/å¤ç”¨ LanguageModel Session
   â†’ temperature: 0.7, topK: 3
              â†“
7. æ„å»ºå®Œæ•´æç¤ºè¯
   â†’ åŠ¨æ€æ³¨å…¥ ${subject}ã€${expA/B/C/D}
   â†’ THINKING + IMPORTANT + HINT ä¸‰æ®µå¼
              â†“
8. Gemini Nano æœ¬åœ°æ¨ç†
   â†’ è¿”å› "**Misconception**: ..."
              â†“
9. Background ç¼“å­˜ç»“æœï¼ˆ1 å°æ—¶ TTLï¼‰
              â†“
10. å‘é€åˆ° Content Script
   â†’ è§£æ Markdownã€æ„å»º HTMLã€æ¸²æŸ“ LaTeX
              â†“
11. ç”¨æˆ·çœ‹åˆ°åˆ†æç»“æœ
   â†’ å­¦ç§‘å›¾æ ‡ã€Misconception å¡ç‰‡ã€åé¦ˆ/ä¿å­˜æŒ‰é’®
```

---

## å­˜å‚¨æ¶æ„

### chrome.storage.localï¼ˆæŒä¹…åŒ–ï¼‰
- **AI åˆ†æç¼“å­˜**ï¼š1 å°æ—¶ TTL
- **é”™é¢˜æœ¬**ï¼šå»é‡å­˜å‚¨ï¼ˆfingerprint + analysisHashï¼‰
- **ç”¨æˆ·è®¾ç½®**ï¼šautoScanEnabled

### chrome.storage.sessionï¼ˆä¸´æ—¶ï¼‰
- é¡µé¢å†…å®¹ã€URLã€æ ‡é¢˜
- ç”¨æˆ·ç­”æ¡ˆã€æ­£ç¡®ç­”æ¡ˆã€rationales
- å­¦ç§‘ä¿¡æ¯

---

## æ¶ˆæ¯æµ

### Background â†” Offscreenï¼ˆAI æ¨ç†é“¾è·¯ï¼‰
- Background â†’ Offscreenï¼šå‘é€åˆ†æè¯·æ±‚ï¼ˆsubjectã€rationalesã€answersï¼‰
- Offscreen â†’ Backgroundï¼šè¿”å›åˆ†æç»“æœï¼ˆresultã€debug infoï¼‰

### Background â†” Content Script
- Background â†’ Contentï¼šæ˜¾ç¤ºåŠ è½½/åˆ†æ/é”™è¯¯çŠ¶æ€
- Content â†’ Backgroundï¼šå†…å®¹è„šæœ¬å°±ç»ªã€é‡æ–°åˆ†æã€ä¿å­˜é”™é¢˜ã€æäº¤åé¦ˆ

---

## å®‰å…¨ä¸éšç§

- âœ… **æœ¬åœ° AI**ï¼šGemini Nano ç¦»çº¿æ¨ç†ï¼Œæ— ç½‘ç»œè¯·æ±‚
- âœ… **URL å“ˆå¸Œ**ï¼šSupabase ä»…å­˜å‚¨ SHA-256(url)
- âœ… **åŒ¿åç”¨æˆ·**ï¼šéšæœºç”Ÿæˆ user_id
- âœ… **DOMPurify**ï¼šè¿‡æ»¤æ‰€æœ‰ HTMLï¼Œé˜²æ­¢ XSS
- âœ… **Session é”™è¯¯æ¢å¤**ï¼šè‡ªåŠ¨é”€æ¯å¹¶é‡å»º

---

## æ€§èƒ½ä¼˜åŒ–

- **ç¼“å­˜ç­–ç•¥**ï¼š1 å°æ—¶ TTLï¼ŒSession å¤ç”¨
- **å†…å­˜ç®¡ç†**ï¼šOffscreen å•ä¾‹ï¼ŒTab æ¸…ç†
- **æ¸²æŸ“ä¼˜åŒ–**ï¼šLaTeX æ‰¹é‡æ¸²æŸ“ï¼ŒMarkdown é¢„å¤„ç†

---

*å®Œæ•´æŠ€æœ¯ç»†èŠ‚è¯·å‚è€ƒè‹±æ–‡ç‰ˆ [ARCHITECTURE.md](../../ARCHITECTURE.md)*

